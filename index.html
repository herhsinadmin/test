<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>éŠ·å”®æˆ°æƒ…å®¤ - GitHub ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 40px; }
        .box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 700px; }
        .btn { background: #1a73e8; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; }
        #status { margin: 15px 0; color: #666; }
    </style>
</head>
<body>
    <div class="box">
        <h1>ğŸ“Š éŠ·è²¨æ˜ç´°æˆ°æƒ…å®¤</h1>
        <p>è«‹ä¸Šå‚³ Excel æª”æ¡ˆï¼Œç³»çµ±å°‡è‡ªå‹•åˆ†é¡ä¸¦å»é‡å­˜å…¥ Google Sheetã€‚</p>
        <input type="file" id="fileInput" accept=".xls,.xlsx" />
        <button class="btn" onclick="uploadData()">é–‹å§‹ä¸Šå‚³</button>
        <div id="status">æº–å‚™å°±ç·’</div>
        <canvas id="myChart"></canvas>
    </div>

    <script>
        // 1. ï¼ï¼ï¼è«‹åœ¨æ­¤è™•è²¼ä¸Šä½ çš„ Google Apps Script ç¶²å€ï¼ï¼ï¼
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzSpLmbTrBKyCwdweo5yD2OK6BA4KLHSNiDiH0sAeZco1mnBa8b9M35EqOs6iyJ028/exec";

        async function uploadData() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert("è«‹é¸æ“‡æª”æ¡ˆ");

            document.getElementById('status').innerText = "è§£ææª”æ¡ˆä¸­...";
            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, range: 7});

                document.getElementById('status').innerText = "ä¸Šå‚³é›²ç«¯è³‡æ–™åº«ä¸­ (é€™å¯èƒ½éœ€è¦ 10-20 ç§’)...";
                
                // å‚³é€è³‡æ–™åˆ° GAS
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({data: rows})
                });
                const result = await response.json();
                document.getElementById('status').innerText = result.result;
                loadDashboard();
            };
            reader.readAsArrayBuffer(file);
        }

        async function loadDashboard() {
            const response = await fetch(GAS_URL);
            const data = await response.json();
            
            const summary = {"åœ‹ç”¢": 0, "äºæ±": 0, "å°æ³¥": 0, "å…¶ä»–": 0};
            data.forEach(r => { summary[r[1]] = (summary[r[1]] || 0) + r[3]; });

            const ctx = document.getElementById('myChart').getContext('2d');
            if (window.chart) window.chart.destroy();
            window.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(summary),
                    datasets: [{
                        label: 'éŠ·å”®ç¸½é¡ (NT$)',
                        data: Object.values(summary),
                        backgroundColor: ['#4285f4', '#db4437', '#f4b400', '#0f9d58']
                    }]
                }
            });
        }

        window.onload = loadDashboard;
    </script>
</body>
</html>
