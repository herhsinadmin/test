<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ä½•é‘«å¯¦æ¥­ - é«˜é€Ÿæˆ°æƒ…å®¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #0d1117; color: #c9d1d9; padding: 20px; }
        .box { background: #161b22; padding: 30px; border-radius: 12px; max-width: 1000px; margin: auto; border: 1px solid #30363d; }
        .stat-card { background: #21262d; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #30363d; margin-bottom: 20px; }
        .stat-value { font-size: 32px; font-weight: bold; color: #3fb950; }
        .upload-zone { background: #0d1117; border: 2px dashed #444; padding: 30px; text-align: center; border-radius: 10px; }
        .btn { background: #238636; color: white; border: none; padding: 12px 40px; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: bold; }
        .btn:disabled { background: #1a4a25; cursor: not-allowed; }
        #status { margin-top: 15px; font-weight: bold; color: #58a6ff; }
        .chart-container { height: 450px; margin-top: 30px; }
    </style>
</head>
<body>
    <div class="box">
        <h1 style="text-align:center; color:#58a6ff;">ğŸš€ éŠ·è²¨æ•¸æ“šé«˜é€Ÿæˆ°æƒ…å®¤</h1>
        
        <div class="stat-card">
            <div style="color: #8b949e; margin-bottom: 10px;">å¹´åº¦ç´¯è¨ˆéŠ·é¡ (æœªç¨…)</div>
            <div id="totalSales" class="stat-value">$0</div>
        </div>

        <div class="upload-zone">
            <input type="file" id="fileInput" accept=".xls,.xlsx" />
            <button id="uploadBtn" class="btn" onclick="uploadData()">åŒæ­¥ä¸¦æ›´æ–°å ±è¡¨</button>
            <div id="status">âœ… ç³»çµ±å°±ç·’ï¼Œè«‹ä¸Šå‚³æª”æ¡ˆ</div>
        </div>

        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzSpLmbTrBKyCwdweo5yD2OK6BA4KLHSNiDiH0sAeZco1mnBa8b9M35EqOs6iyJ028/exec"; // ï¼ï¼ï¼è«‹æ›æˆä½ çš„ç¶²å€ï¼ï¼ï¼
        Chart.register(ChartDataLabels);

        async function uploadData() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert("è«‹é¸å– Excel æª”æ¡ˆ");
            
            const btn = document.getElementById('uploadBtn');
            const status = document.getElementById('status');
            btn.disabled = true;
            status.innerText = "â³ æ­£åœ¨æœ¬æ©Ÿé ç®—åŠ ç¸½ (ä¸æ¶ˆè€—ç¶²è·¯)...";

            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, range: 7});

                // --- å‰ç«¯é å…ˆåŠ ç¸½ (é—œéµå„ªåŒ–) ---
                const summaryMap = {};
                rows.forEach(r => {
                    const name = r[2], date = r[3], id = r[5], doc = r[7], amt = parseFloat(r[10]);
                    if (doc === "éŠ·è²¨" && id && !isNaN(amt)) {
                        if (!summaryMap[id]) {
                            let type = "å…¶ä»–";
                            if (name.indexOf("åœ‹ç”¢") === 0) type = "åœ‹ç”¢";
                            else if (name.indexOf("äºæ±") === 0) type = "äºæ±";
                            else if (name.indexOf("å°æ³¥") === 0) type = "å°æ³¥";
                            summaryMap[id] = { id, date, name, type, amount: 0 };
                        }
                        summaryMap[id].amount += amt;
                    }
                });
                const aggregatedArray = Object.values(summaryMap);

                status.innerText = `â˜ï¸ å‚³è¼¸ä¸­ (å…± ${aggregatedArray.length} ç­†å–®æ“š)...`;

                try {
                    const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({data: aggregatedArray}) });
                    const result = await response.json();
                    status.innerText = "âœ… " + result.message;
                    loadDashboard();
                } catch(err) {
                    status.innerText = "âŒ åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–ç¶²è·¯";
                } finally {
                    btn.disabled = false;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function loadDashboard() {
            const response = await fetch(GAS_URL);
            const data = await response.json();
            
            let grandTotal = 0;
            const datasetValues = { "åœ‹ç”¢": Array(12).fill(0), "äºæ±": Array(12).fill(0), "å°æ³¥": Array(12).fill(0), "å…¶ä»–": Array(12).fill(0) };

            data.forEach(r => {
                const date = new Date(r[0]);
                const mIdx = date.getMonth(); 
                const type = r[1], amount = r[3];
                if (datasetValues[type] && mIdx >= 0 && mIdx < 12) {
                    datasetValues[type][mIdx] += amount;
                    grandTotal += amount;
                }
            });

            document.getElementById('totalSales').innerText = '$' + Math.round(grandTotal).toLocaleString();

            const ctx = document.getElementById('myChart').getContext('2d');
            if (window.chart) window.chart.destroy();
            window.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"],
                    datasets: [
                        { label: 'åœ‹ç”¢', data: datasetValues["åœ‹ç”¢"], backgroundColor: '#58a6ff' },
                        { label: 'äºæ±', data: datasetValues["äºæ±"], backgroundColor: '#f85149' },
                        { label: 'å°æ³¥', data: datasetValues["å°æ³¥"], backgroundColor: '#d29922' },
                        { label: 'å…¶ä»–', data: datasetValues["å…¶ä»–"], backgroundColor: '#3fb950' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
                    plugins: {
                        datalabels: {
                            anchor: 'end', align: 'top', color: '#c9d1d9',
                            formatter: (v, c) => {
                                if (c.datasetIndex === 3) {
                                    let s = 0;
                                    c.chart.data.datasets.forEach(ds => s += ds.data[c.dataIndex]);
                                    return s > 0 ? '$' + Math.round(s/1000) + 'k' : '';
                                }
                                return null;
                            }
                        }
                    }
                }
            });
        }
        window.onload = loadDashboard;
    </script>
</body>
</html>
