<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ä½•é‘«å¯¦æ¥­ - éŠ·å”®æˆ°æƒ…å®¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #0b0e14; color: #e0e0e0; padding: 20px; }
        .box { background: #161b22; padding: 30px; border-radius: 12px; max-width: 1100px; margin: auto; border: 1px solid #30363d; }
        h1 { color: #58a6ff; text-align: center; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #21262d; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #30363d; }
        .stat-value { font-size: 24px; font-weight: bold; color: #3fb950; }
        .upload-zone { background: #0d1117; border: 2px dashed #30363d; padding: 20px; text-align: center; border-radius: 10px; margin-bottom: 30px; }
        .btn { background: #238636; color: white; border: none; padding: 10px 30px; border-radius: 6px; cursor: pointer; font-size: 16px; }
        #status { margin-top: 10px; color: #8b949e; }
        .chart-container { height: 500px; width: 100%; }
    </style>
</head>
<body>
    <div class="box">
        <h1>ğŸ“Š éŠ·è²¨æ•¸æ“šæˆ°æƒ…å®¤ (æœªç¨…é‡‘é¡)</h1>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div>å¹´åº¦ç´¯è¨ˆéŠ·é¡</div>
                <div id="totalSales" class="stat-value">$0</div>
            </div>
            <div class="stat-card">
                <div>è³‡æ–™åº«ç‹€æ…‹</div>
                <div id="status" style="font-size: 16px; color: #58a6ff;">é€£ç·šä¸­...</div>
            </div>
        </div>

        <div class="upload-zone">
            <input type="file" id="fileInput" accept=".xls,.xlsx" />
            <button class="btn" onclick="uploadData()">åŒæ­¥è³‡æ–™ä¸¦è¦†è“‹</button>
        </div>

        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzSpLmbTrBKyCwdweo5yD2OK6BA4KLHSNiDiH0sAeZco1mnBa8b9M35EqOs6iyJ028/exec"; // è«‹æ›æˆä½ çš„éƒ¨ç½²ç¶²å€
        Chart.register(ChartDataLabels);

        async function uploadData() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert("è«‹é¸å– Excel æª”æ¡ˆ");
            document.getElementById('status').innerText = "â³ æ­£åœ¨è™•ç†æ•¸æ“šä¸¦è‡ªå‹•åŠ ç¸½å–®æ“š...";
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, range: 7});
                const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({data: rows}) });
                const result = await response.json();
                document.getElementById('status').innerText = result.result;
                loadDashboard();
            };
            reader.readAsArrayBuffer(file);
        }

        async function loadDashboard() {
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                
                let grandTotal = 0;
                const monthsLabels = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"];
                const datasetValues = { "åœ‹ç”¢": Array(12).fill(0), "äºæ±": Array(12).fill(0), "å°æ³¥": Array(12).fill(0), "å…¶ä»–": Array(12).fill(0) };

                data.forEach(r => {
                    const date = new Date(r[0]);
                    const mIdx = date.getMonth(); 
                    const type = r[1];
                    const amount = r[3];
                    if (datasetValues[type] && mIdx >= 0 && mIdx < 12) {
                        datasetValues[type][mIdx] += amount;
                        grandTotal += amount;
                    }
                });

                document.getElementById('totalSales').innerText = '$' + Math.round(grandTotal).toLocaleString();

                const ctx = document.getElementById('myChart').getContext('2d');
                if (window.chart) window.chart.destroy();

                window.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: monthsLabels,
                        datasets: [
                            { label: 'åœ‹ç”¢', data: datasetValues["åœ‹ç”¢"], backgroundColor: '#1f6feb' },
                            { label: 'äºæ±', data: datasetValues["äºæ±"], backgroundColor: '#da3633' },
                            { label: 'å°æ³¥', data: datasetValues["å°æ³¥"], backgroundColor: '#d29922' },
                            { label: 'å…¶ä»–', data: datasetValues["å…¶ä»–"], backgroundColor: '#238636' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true, ticks: { color: '#8b949e' } },
                            y: { stacked: true, ticks: { color: '#8b949e' }, beginAtZero: true }
                        },
                        plugins: {
                            legend: { labels: { color: '#c9d1d9' } },
                            datalabels: {
                                anchor: 'end', align: 'top', color: '#3fb950',
                                formatter: (val, ctx) => {
                                    if (ctx.datasetIndex === 3) { // åœ¨æœ€å¾Œä¸€å€‹é¡åˆ¥(å…¶ä»–)é¡¯ç¤ºç¸½é¡
                                        let sum = 0;
                                        ctx.chart.data.datasets.forEach(ds => sum += ds.data[ctx.dataIndex]);
                                        return sum > 0 ? '$' + Math.round(sum/1000).toLocaleString() + 'k' : '';
                                    }
                                    return null;
                                },
                                font: { weight: 'bold' }
                            }
                        }
                    }
                });
            } catch(e) { document.getElementById('status').innerText = "é€£ç·šå¤±æ•—"; }
        }
        window.onload = loadDashboard;
    </script>
</body>
</html>
