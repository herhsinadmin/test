<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ä½•é‘«å¯¦æ¥­ - çµ‚æ¥µæˆ°æƒ…å®¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #121212; color: white; padding: 20px; }
        .box { background: #1e1e1e; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); max-width: 1100px; margin: auto; }
        .header { text-align: center; margin-bottom: 25px; color: #00d4ff; }
        .upload-zone { background: #2a2a2a; border: 2px dashed #444; padding: 20px; text-align: center; border-radius: 10px; margin-bottom: 30px; }
        .btn { background: #00d4ff; color: #000; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        #status { margin-top: 10px; font-weight: bold; color: #aaa; }
        .chart-container { position: relative; height: 60vh; width: 100%; }
    </style>
</head>
<body>
    <div class="box">
        <div class="header">
            <h1>ğŸš€ éŠ·è²¨æ•¸æ“šå³æ™‚ç›£æ§æˆ°æƒ…å®¤</h1>
        </div>

        <div class="upload-zone">
            <input type="file" id="fileInput" accept=".xls,.xlsx" />
            <button class="btn" onclick="uploadData()">åŒæ­¥æœ€æ–°è³‡æ–™</button>
            <div id="status">è®€å–é›²ç«¯æ­·å²æ•¸æ“šä¸­...</div>
        </div>

        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzSpLmbTrBKyCwdweo5yD2OK6BA4KLHSNiDiH0sAeZco1mnBa8b9M35EqOs6iyJ028/exec"; // ï¼ï¼ï¼è«‹æ›æˆä½ çš„ç¶²å€ï¼ï¼ï¼
        Chart.register(ChartDataLabels);

        async function uploadData() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert("è«‹é¸å– Excel æª”æ¡ˆ");
            document.getElementById('status').innerText = "â³ æ­£åœ¨æ¯”å°å–®è™Ÿä¸¦æ›´æ–°è³‡æ–™åº«...";
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, range: 7});

                const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({data: rows}) });
                const result = await response.json();
                document.getElementById('status').innerText = result.result;
                loadDashboard();
            };
            reader.readAsArrayBuffer(file);
        }

        async function loadDashboard() {
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                
                // å›ºå®š 1-12 æœˆæ¨™ç±¤
                const monthsLabels = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"];
                const categories = ["åœ‹ç”¢", "äºæ±", "å°æ³¥", "å…¶ä»–"];
                const datasetValues = {
                    "åœ‹ç”¢": Array(12).fill(0), "äºæ±": Array(12).fill(0), "å°æ³¥": Array(12).fill(0), "å…¶ä»–": Array(12).fill(0)
                };

                data.forEach(r => {
                    const date = new Date(r[0]);
                    const mIdx = date.getMonth(); 
                    const type = r[1];
                    const amount = r[3];
                    if (datasetValues[type]) datasetValues[type][mIdx] += amount;
                });

                const ctx = document.getElementById('myChart').getContext('2d');
                if (window.chart) window.chart.destroy();

                window.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: monthsLabels,
                        datasets: [
                            { label: 'åœ‹ç”¢', data: datasetValues["åœ‹ç”¢"], backgroundColor: '#00d4ff' },
                            { label: 'äºæ±', data: datasetValues["äºæ±"], backgroundColor: '#ff4d4d' },
                            { label: 'å°æ³¥', data: datasetValues["å°æ³¥"], backgroundColor: '#ffcc00' },
                            { label: 'å…¶ä»–', data: datasetValues["å…¶ä»–"], backgroundColor: '#00ff88' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true, grid: { color: '#333' }, ticks: { color: '#fff' } },
                            y: { stacked: true, beginAtZero: true, grid: { color: '#333' }, ticks: { color: '#fff' } }
                        },
                        plugins: {
                            legend: { labels: { color: '#fff' } },
                            datalabels: {
                                anchor: 'end', align: 'top', color: '#fff',
                                formatter: (val, ctx) => {
                                    if (ctx.datasetIndex === ctx.chart.data.datasets.length - 1) {
                                        let sum = 0;
                                        ctx.chart.data.datasets.forEach(ds => sum += ds.data[ctx.dataIndex]);
                                        return sum > 0 ? '$' + Math.round(sum).toLocaleString() : '';
                                    }
                                    return null;
                                },
                                font: { weight: 'bold' }
                            }
                        }
                    }
                });
                document.getElementById('status').innerText = "âœ… æ­·å²æ•¸æ“šå·²åŒæ­¥";
            } catch(e) { console.error(e); }
        }

        window.onload = loadDashboard;
    </script>
</body>
</html>
