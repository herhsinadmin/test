<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ä½•é‘«å¯¦æ¥­ - éŠ·è²¨çµ‚æ¥µæˆ°æƒ…å®¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #0d1117; color: #c9d1d9; padding: 20px; }
        .box { background: #161b22; padding: 30px; border-radius: 12px; max-width: 1100px; margin: auto; border: 1px solid #30363d; }
        h1 { text-align: center; color: #58a6ff; margin-bottom: 30px; }
        
        /* ç¸½é¡å¤§å¡ç‰‡ */
        .main-stat { background: #21262d; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #30363d; margin-bottom: 20px; }
        .main-value { font-size: 36px; font-weight: bold; color: #3fb950; }
        
        /* å››å¤§é¡åˆ¥å°å¡ç‰‡ */
        .sub-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .category-card { background: #1c2128; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #30363d; border-top: 4px solid #58a6ff; }
        .cat-name { color: #8b949e; font-size: 14px; margin-bottom: 5px; }
        .cat-value { font-size: 18px; font-weight: bold; }

        /* ä¸Šå‚³å€ */
        .upload-zone { background: #0d1117; border: 2px dashed #444; padding: 25px; text-align: center; border-radius: 10px; margin-bottom: 30px; }
        .btn { background: #238636; color: white; border: none; padding: 12px 40px; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: bold; }
        .btn:disabled { background: #1a4a25; cursor: not-allowed; }
        #status { margin-top: 15px; font-weight: bold; color: #58a6ff; font-size: 14px; }

        .chart-container { height: 450px; }
    </style>
</head>
<body>
    <div class="box">
        <h1>ğŸ“Š éŠ·è²¨æ•¸æ“šå³æ™‚æˆ°æƒ…å®¤</h1>
        
        <div class="main-stat">
            <div style="color: #8b949e; margin-bottom: 10px;">å¹´åº¦ç¸½éŠ·é¡ç´¯è¨ˆ (æœªç¨…)</div>
            <div id="totalSales" class="main-value">$0</div>
        </div>

        <div class="sub-stats">
            <div class="category-card" style="border-top-color: #d29922;">
                <div class="cat-name">å°æ³¥ç´¯è¨ˆ</div>
                <div id="total-å°æ³¥" class="cat-value">$0</div>
            </div>
            <div class="category-card" style="border-top-color: #58a6ff;">
                <div class="cat-name">åœ‹ç”¢ç´¯è¨ˆ</div>
                <div id="total-åœ‹ç”¢" class="cat-value">$0</div>
            </div>
            <div class="category-card" style="border-top-color: #f85149;">
                <div class="cat-name">äºæ±ç´¯è¨ˆ</div>
                <div id="total-äºæ±" class="cat-value">$0</div>
            </div>
            <div class="category-card" style="border-top-color: #3fb950;">
                <div class="cat-name">å…¶ä»–ç´¯è¨ˆ</div>
                <div id="total-å…¶ä»–" class="cat-value">$0</div>
            </div>
        </div>

        <div class="upload-zone">
            <input type="file" id="fileInput" accept=".xls,.xlsx" />
            <button id="uploadBtn" class="btn" onclick="uploadData()">åŒæ­¥è³‡æ–™åº«</button>
            <div id="status">âœ… ç³»çµ±é€£ç·šæ­£å¸¸</div>
        </div>

        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzSpLmbTrBKyCwdweo5yD2OK6BA4KLHSNiDiH0sAeZco1mnBa8b9M35EqOs6iyJ028/exec"; // ï¼ï¼ï¼è«‹æ›æˆä½ çš„ Google éƒ¨ç½²ç¶²å€ï¼ï¼ï¼
        Chart.register(ChartDataLabels);

        async function uploadData() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert("è«‹é¸å–æª”æ¡ˆ");
            
            const btn = document.getElementById('uploadBtn');
            const status = document.getElementById('status');
            btn.disabled = true;
            status.innerText = "â³ æ­£åœ¨åˆ†æ Excel è³‡æ–™ä¸¦è¨ˆç®—å–®æ“šç¸½é¡...";

            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, range: 7});

                const summaryMap = {};
                rows.forEach(r => {
                    const name = r[2], date = r[3], id = r[5], doc = r[7], amt = parseFloat(r[10]);
                    if (doc === "éŠ·è²¨" && id && !isNaN(amt)) {
                        if (!summaryMap[id]) {
                            let type = "å…¶ä»–";
                            if (name.indexOf("å°æ³¥") === 0) type = "å°æ³¥";
                            else if (name.indexOf("åœ‹ç”¢") === 0) type = "åœ‹ç”¢";
                            else if (name.indexOf("äºæ±") === 0) type = "äºæ±";
                            summaryMap[id] = { id, date, name, type, amount: 0 };
                        }
                        summaryMap[id].amount += amt;
                    }
                });

                const aggregatedArray = Object.values(summaryMap);
                status.innerText = `â˜ï¸ æ­£åœ¨åŒæ­¥ ${aggregatedArray.length} ç­†å–®æ“šè‡³é›²ç«¯è©¦ç®—è¡¨...`;

                try {
                    const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({data: aggregatedArray}) });
                    const result = await response.json();
                    status.innerText = "âœ… " + result.message;
                    loadDashboard();
                } catch(err) {
                    status.innerText = "âŒ é€£ç·šå¤±æ•—";
                } finally {
                    btn.disabled = false;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function loadDashboard() {
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                
                let grandTotal = 0;
                const catTotals = { "å°æ³¥": 0, "åœ‹ç”¢": 0, "äºæ±": 0, "å…¶ä»–": 0 };
                const monthlyValues = { "å°æ³¥": Array(12).fill(0), "åœ‹ç”¢": Array(12).fill(0), "äºæ±": Array(12).fill(0), "å…¶ä»–": Array(12).fill(0) };

                data.forEach(r => {
                    const date = new Date(r[0]);
                    const mIdx = date.getMonth(); 
                    const type = r[1], amount = r[3];
                    if (catTotals.hasOwnProperty(type)) {
                        catTotals[type] += amount;
                        grandTotal += amount;
                        if (mIdx >= 0 && mIdx < 12) {
                            monthlyValues[type][mIdx] += amount;
                        }
                    }
                });

                // æ›´æ–° UI ä¸Šçš„æ•¸å­—
                document.getElementById('totalSales').innerText = '$' + Math.round(grandTotal).toLocaleString();
                for (let cat in catTotals) {
                    document.getElementById('total-' + cat).innerText = '$' + Math.round(catTotals[cat]).toLocaleString();
                }

                const ctx = document.getElementById('myChart').getContext('2d');
                if (window.chart) window.chart.destroy();
                window.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"],
                        datasets: [
                            { label: 'å°æ³¥', data: monthlyValues["å°æ³¥"], backgroundColor: '#d29922' },
                            { label: 'åœ‹ç”¢', data: monthlyValues["åœ‹ç”¢"], backgroundColor: '#58a6ff' },
                            { label: 'äºæ±', data: monthlyValues["äºæ±"], backgroundColor: '#f85149' },
                            { label: 'å…¶ä»–', data: monthlyValues["å…¶ä»–"], backgroundColor: '#3fb950' }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
                        plugins: {
                            legend: { labels: { color: '#c9d1d9' } },
                            datalabels: {
                                anchor: 'end', align: 'top', color: '#c9d1d9',
                                formatter: (v, c) => {
                                    if (c.datasetIndex === 3) {
                                        let s = 0;
                                        c.chart.data.datasets.forEach(ds => s += ds.data[c.dataIndex]);
                                        return s > 0 ? '$' + Math.round(s/1000).toLocaleString() + 'k' : '';
                                    }
                                    return null;
                                }
                            }
                        }
                    }
                });
            } catch(e) { console.error(e); }
        }
        window.onload = loadDashboard;
    </script>
</body>
</html>
