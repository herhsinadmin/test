<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ä½•é‘«å¯¦æ¥­ - éŠ·è²¨æˆ°æƒ…å®¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f8f9fa; padding: 30px; }
        .box { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); max-width: 900px; margin: auto; }
        .header { text-align: center; border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; }
        .upload-section { background: #e9ecef; padding: 20px; border-radius: 10px; margin-bottom: 30px; text-align: center; }
        .btn { background: #28a745; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn:hover { background: #218838; }
        #status { margin-top: 10px; font-weight: bold; color: #555; }
        canvas { max-height: 400px; }
    </style>
</head>
<body>
    <div class="box">
        <div class="header">
            <h1>ğŸ¬ éŠ·è²¨æ¥­ç¸¾è¶¨å‹¢æˆ°æƒ…å®¤</h1>
        </div>

        <div class="upload-section">
            <input type="file" id="fileInput" accept=".xls,.xlsx" />
            <button class="btn" onclick="uploadData()">ç¢ºèªä¸Šå‚³ä¸¦æ›´æ–°åœ–è¡¨</button>
            <div id="status">ç³»çµ±å°±ç·’</div>
        </div>

        <div>
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <script>
        // ï¼ï¼ï¼è«‹æ›¿æ›æˆä½ çš„ Google Apps Script éƒ¨ç½²ç¶²å€ï¼ï¼ï¼
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzSpLmbTrBKyCwdweo5yD2OK6BA4KLHSNiDiH0sAeZco1mnBa8b9M35EqOs6iyJ028/exec";

        async function uploadData() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼");

            document.getElementById('status').innerText = "ğŸš€ æ­£åœ¨è§£æ Excel ä¸¦éæ¿¾ééŠ·è²¨é …ç›®...";
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                // å¾ç¬¬ 8 è¡Œé–‹å§‹è®€å– (range: 7)
                const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, range: 7});

                document.getElementById('status').innerText = "â˜ï¸ æ­£åœ¨èˆ‡é›²ç«¯åŒæ­¥...";
                
                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({data: rows})
                    });
                    const result = await response.json();
                    document.getElementById('status').innerText = result.result;
                    loadDashboard(); // é‡æ–°æ•´ç†åœ–è¡¨
                } catch(err) {
                    document.getElementById('status').innerText = "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¶²å€";
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function loadDashboard() {
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                
                // æ•¸æ“šè™•ç†ï¼šä¾æœˆä»½èˆ‡é¡åˆ¥åˆ†é¡
                const monthlyData = {}; // { "2026-01": { "åœ‹ç”¢": 0, ... }, ... }

                data.forEach(r => {
                    const date = new Date(r[0]);
                    const month = date.getFullYear() + "-" + ("0" + (date.getMonth() + 1)).slice(-2);
                    const type = r[1];
                    const amount = r[3];

                    if (!monthlyData[month]) monthlyData[month] = {"åœ‹ç”¢": 0, "äºæ±": 0, "å°æ³¥": 0, "å…¶ä»–": 0};
                    monthlyData[month][type] += amount;
                });

                const months = Object.keys(monthlyData).sort();
                const categories = ["åœ‹ç”¢", "äºæ±", "å°æ³¥", "å…¶ä»–"];
                const colors = ['#4285f4', '#db4437', '#f4b400', '#0f9d58'];

                const datasets = categories.map((cat, i) => ({
                    label: cat,
                    data: months.map(m => monthlyData[m][cat]),
                    backgroundColor: colors[i]
                }));

                const ctx = document.getElementById('myChart').getContext('2d');
                if (window.chart) window.chart.destroy();
                window.chart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: months, datasets: datasets },
                    options: {
                        responsive: true,
                        scales: { x: { stacked: false }, y: { beginAtZero: true, title: { display: true, text: 'æœªç¨…ç¸½é¡' } } },
                        plugins: { title: { display: true, text: 'æ¯æœˆå®¢æˆ¶é¡åˆ¥éŠ·è²¨çµ±è¨ˆ' } }
                    }
                });
            } catch(e) { console.log("åœ–è¡¨è¼‰å…¥å¤±æ•—", e); }
        }

        window.onload = loadDashboard;
    </script>
</body>
</html>
