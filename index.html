<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ä½•é‘«å¯¦æ¥­ - éŠ·å”®æˆ°æƒ…å®¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 20px; }
        .box { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 1000px; margin: auto; }
        .header { text-align: center; margin-bottom: 25px; }
        .upload-zone { background: #f8f9fa; border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 10px; margin-bottom: 30px; }
        .btn { background: #007bff; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        #status { margin-top: 10px; font-weight: bold; color: #666; }
        .chart-container { position: relative; height: 50vh; width: 100%; }
    </style>
</head>
<body>
    <div class="box">
        <div class="header">
            <h1>ðŸ“Š å¹´åº¦éŠ·è²¨æˆ°æƒ…ç›£æŽ§å®¤</h1>
        </div>

        <div class="upload-zone">
            <input type="file" id="fileInput" accept=".xls,.xlsx" />
            <button class="btn" onclick="uploadData()">ä¸Šå‚³æœ€æ–°æ˜Žç´°è¡¨</button>
            <div id="status">ç³»çµ±å°±ç·’</div>
        </div>

        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <script>
        // ï¼ï¼ï¼è«‹æ›¿æ›æˆä½ çš„ Google Apps Script ç¶²å€ï¼ï¼ï¼
        const GAS_URL = "YOUR_GAS_URL";

        // è¨»å†Šæ¨™ç±¤å¤–æŽ›
        Chart.register(ChartDataLabels);

        async function uploadData() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼");
            document.getElementById('status').innerText = "â³ è™•ç†ä¸­...";
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, range: 7});

                try {
                    const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({data: rows}) });
                    const result = await response.json();
                    document.getElementById('status').innerText = result.result;
                    loadDashboard();
                } catch(err) {
                    document.getElementById('status').innerText = "âŒ é€£ç·šå¤±æ•—";
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function loadDashboard() {
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                
                // åˆå§‹åŒ– 1-12 æœˆæ•¸æ“š
                const months = ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];
                const categories = ["åœ‹ç”¢", "äºžæ±", "å°æ³¥", "å…¶ä»–"];
                const chartData = {
                    "åœ‹ç”¢": Array(12).fill(0),
                    "äºžæ±": Array(12).fill(0),
                    "å°æ³¥": Array(12).fill(0),
                    "å…¶ä»–": Array(12).fill(0)
                };

                data.forEach(r => {
                    const date = new Date(r[0]);
                    const mIdx = date.getMonth(); // 0-11
                    const type = r[1];
                    const amount = r[3];
                    if (chartData[type]) chartData[type][mIdx] += amount;
                });

                const ctx = document.getElementById('myChart').getContext('2d');
                if (window.chart) window.chart.destroy();

                window.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months.map(m => m + "æœˆ"),
                        datasets: [
                            { label: 'åœ‹ç”¢', data: chartData["åœ‹ç”¢"], backgroundColor: '#4285f4' },
                            { label: 'äºžæ±', data: chartData["äºžæ±"], backgroundColor: '#db4437' },
                            { label: 'å°æ³¥', data: chartData["å°æ³¥"], backgroundColor: '#f4b400' },
                            { label: 'å…¶ä»–', data: chartData["å…¶ä»–"], backgroundColor: '#0f9d58' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true }, // å †ç–Šé¡¯ç¤ºæ›´æ¸…æ¥šç¸½é¡
                            y: { stacked: true, beginAtZero: true }
                        },
                        plugins: {
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value, context) => {
                                    // åªåœ¨æœ€é ‚éƒ¨çš„ dataset é¡¯ç¤ºç¸½é¡
                                    if (context.datasetIndex === context.chart.data.datasets.length - 1) {
                                        let sum = 0;
                                        context.chart.data.datasets.forEach(ds => {
                                            sum += ds.data[context.dataIndex];
                                        });
                                        return sum > 0 ? '$' + Math.round(sum).toLocaleString() : '';
                                    }
                                    return null;
                                },
                                font: { weight: 'bold', size: 12 }
                            },
                            tooltip: {
                                callbacks: {
                                    footer: (items) => {
                                        let total = 0;
                                        items.forEach(i => total += i.parsed.y);
                                        return 'æœˆç¸½è¨ˆ: $' + total.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            } catch(e) { console.error(e); }
        }

        window.onload = loadDashboard;
    </script>
</body>
</html>
